<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>이용자 화면</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root { --bottom-safe: 32px; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      color: #fff;
      font-family: "Malgun Gothic","맑은 고딕",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      overflow: hidden; /* 페이지 자체 스크롤 제거 */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* 컨테이너 제거하고 출력 영역 하나만 씀: 항상 위에서부터 시작 */
    #output {
      box-sizing: border-box;
      height: calc(100dvh - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px));
      width: 100%;
      padding:
        calc(env(safe-area-inset-top,0px) + 12px)
        5vw
        calc(env(safe-area-inset-bottom,0px) + var(--bottom-safe) + 12px)
        5vw;

      background: #111;
      border-top: 2px solid #333;
      border-bottom: 2px solid #333;

      /* ✅ 글자 크기: 시니어 친화 */
      /* 데스크톱 기본(너무 작지 않게) */
      font-size: clamp(28px, 3.5vw, 72px);
      line-height: 1.5;
      text-align: left;

      /* 내용 표시 */
      white-space: pre-wrap;
      word-break: break-word;

      /* 내부 스크롤: 항상 위에서 시작 */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      /* 가독성 향상 */
      text-shadow: 2px 2px 5px rgba(0,0,0,0.85);
    }

    /* ✅ 모바일 세로: 훨씬 크게 */
    @media (orientation: portrait) {
      #output { font-size: clamp(32px, 7.5vw, 96px); }
    }

    /* ✅ 모바일 가로: 공간 고려해 조금 작게 */
    @media (orientation: landscape) {
      #output { font-size: clamp(26px, 4.5vw, 80px); }
    }
  </style>
</head>
<body>
  <div id="output">인증 중...</div>

  <script>
    const output = document.getElementById('output');
    const params = new URLSearchParams(window.location.search);
    const jobId = params.get('job');

    // 하단 시스템바/툴바 가림 방지: VisualViewport로 안전 여백 동적 계산
    function updateBottomSafe(){
      let extra = 32;
      const vv = window.visualViewport;
      if (vv) {
        const obscured = Math.max(0, window.innerHeight - (vv.height + vv.offsetTop));
        extra = Math.max(24, Math.round(obscured + 10)); // 여유 10px
      }
      document.documentElement.style.setProperty('--bottom-safe', extra + 'px');
    }

    function scrollToBottomNow(){ output.scrollTop = output.scrollHeight; }
    function scrollToBottomHard(){
      // 표시 직후/레이아웃 재계산 지연까지 커버
      scrollToBottomNow();
      requestAnimationFrame(()=>{ scrollToBottomNow();
        requestAnimationFrame(()=>{ scrollToBottomNow();
          setTimeout(scrollToBottomNow, 16);
          setTimeout(scrollToBottomNow, 60);
          setTimeout(scrollToBottomNow, 140);
        });
      });
    }

    async function authFlow(){
      let tries = 3;
      while (tries-- > 0) {
        const pin = prompt('속기사가 알려준 4자리 비밀번호를 입력하세요:');
        if (pin === null) { output.textContent = '인증 취소'; return false; }
        const resp = await fetch('/auth_job', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ job_id: jobId, pin: pin })
        });
        const j = await resp.json();
        if (j.ok) return true;
        alert('인증 실패: ' + (j.message || ''));
      }
      output.textContent = '인증 실패. 페이지를 닫아주세요.';
      return false;
    }

    function startSocket(){
      const socket = io();
      socket.on('show_full_text', (payload) => {
        if (!payload || payload.job_id !== jobId) return;
        output.textContent = payload.text;   // 내용은 위에서부터 보임
        updateBottomSafe();
        scrollToBottomHard();                // ✅ 새 입력 시마다 최신 줄로 자동 스크롤
      });

      // 재연결/회전/리사이즈에도 보정
      socket.on('connect', () => scrollToBottomHard());
      window.addEventListener('resize', () => { updateBottomSafe(); scrollToBottomHard(); });
      window.addEventListener('orientationchange', () => setTimeout(()=>{ updateBottomSafe(); scrollToBottomHard(); }, 150));
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', () => { updateBottomSafe(); scrollToBottomHard(); });
        visualViewport.addEventListener('scroll', () => { updateBottomSafe(); scrollToBottomHard(); });
      }
    }

    // 시작 로직
    (async function init(){
      updateBottomSafe();
      if (!jobId) {
        output.textContent = '유효한 세션 링크로 접속하세요. 예: ?job=ABC123';
        return;
      }
      const ok = await authFlow();
      if (!ok) return;
      output.textContent = ''; // 인증 성공 시 빈 상태부터 시작(맨 위 정렬)
      startSocket();
    })();
  </script>
</body>
</html>
